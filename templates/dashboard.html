{% extends "base.html" %}
{% block content %}
<div class="container mt-5">

  <!-- TÃ­tulo -->
  <h2 class="text-center mb-4">ðŸ“‹ <span style="color: #00bcd4;">Tus Tareas</span></h2>

  <!-- Formulario nueva tarea -->
  <form method="POST" action="{{ url_for('add_task') }}" class="d-flex justify-content-center mb-4">
    <input type="text" name="title" class="form-control w-50" placeholder="Escribe una nueva tarea..." required>
    <button type="submit" class="btn btn-success ms-2">Agregar</button>
  </form>

  <!-- Lista de tareas -->
  <ul id="taskList" class="list-group mb-4">
    {% if tasks %}
      {% for task in tasks %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          {{ task.title }}
          <form method="POST" action="{{ url_for('delete_task', task_id=task.id) }}">
            <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
          </form>
        </li>
      {% endfor %}
    {% else %}
      <li class="list-group-item text-center text-secondary">âœ¨ AÃºn no tienes tareas. Â¡Crea la primera arriba!</li>
    {% endif %}
  </ul>

  <!-- Asistente IA -->
  <div class="card p-3 bg-dark text-light">
    <h4>ðŸ¤– Asistente IA</h4>
    <div id="chatBox" class="p-3 bg-black rounded" style="height: 250px; overflow-y: auto;"></div>

    <div class="d-flex mt-3">
      <input type="text" id="userMessage" class="form-control" placeholder="Escribe algo para el asistente...">
      <button id="sendBtn" class="btn btn-info ms-2">Enviar</button>
    </div>
  </div>
</div>

<!-- Script para IA -->
<script>
async function cargarTareas() {
  const res = await fetch("/get_tasks");
  const data = await res.json();
  const lista = document.getElementById("taskList");

  lista.innerHTML = "";

  if (data.tasks.length === 0) {
    lista.innerHTML = '<li class="list-group-item text-center text-secondary">âœ¨ AÃºn no tienes tareas.</li>';
  } else {
    data.tasks.forEach(task => {
      lista.innerHTML += `
        <li class="list-group-item d-flex justify-content-between align-items-center">
          ${task.title}
          <form method="POST" action="/delete_task/${task.id}" style="display:inline;">
            <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
          </form>
        </li>
      `;
    });
  }
}

document.getElementById("sendBtn").addEventListener("click", async () => {
  const input = document.getElementById("userMessage");
  const chatBox = document.getElementById("chatBox");
  const message = input.value.trim();
  if (!message) return;

  chatBox.innerHTML += `<div class='text-end mb-2'><span class='badge bg-info text-dark p-2'>${message}</span></div>`;
  input.value = "";
  chatBox.scrollTop = chatBox.scrollHeight;

  const res = await fetch("/ai_assistant", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message })
  });
  const data = await res.json();

  chatBox.innerHTML += `<div class='text-start mb-2'><span class='badge bg-secondary p-2'>${data.reply}</span></div>`;
  chatBox.scrollTop = chatBox.scrollHeight;

  // Si la IA confirma tarea agregada
  if (data.reply.includes("âœ… Tarea aÃ±adida")) {
    await cargarTareas();
  }
});
</script>
{% endblock %}
